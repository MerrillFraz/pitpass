name: 'Terraform Infrastructure Deployment'

on:
  push:
    branches:
      - main  # Triggers deployment when you merge into main
  pull_request:
    branches:
      - main  # Runs a 'plan' to preview changes during PRs

permissions:
  contents: 'read'
  id-token: 'write' # Essential for Workload Identity Federation

jobs:
  test:
    name: 'Test Application'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Use a consistent Node.js version

      - name: Install Dependencies
        run: npm install # Installs dependencies for all workspaces

      - name: Run Backend Tests
        run: npm test -w packages/backend

      - name: Run Frontend Tests
        run: npm test -w packages/frontend

  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    needs: test # Ensure tests pass before proceeding to Terraform
    
    # Environment variables to keep the code clean
    env:
      GOOGLE_PROJECT_ID: 'clean-sylph-483415-q7' # Replace with your alphanumeric project ID
      WIF_PROVIDER: 'projects/551834006504/locations/global/workloadIdentityPools/github-pool/providers/github'
      SERVICE_ACCOUNT: 'terraform-deployer@clean-sylph-483415-q7.iam.gserviceaccount.com'
      TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
      TF_VAR_db_user: ${{ secrets.DB_USER }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Modern keyless authentication for 2026
      - name: Authenticate to Google Cloud
        id: 'auth'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}
          audience: 'github.com'

      - name: Docker Auth
        run: gcloud auth configure-docker us-east1-docker.pkg.dev

      - name: Build and Push Backend
        run: |
          # Build from the root (.) so we can include the prisma config, 
          # but point to the specific Dockerfile inside the backend folder.
          docker build -f ./packages/backend/Dockerfile . -t us-east1-docker.pkg.dev/${{ env.GOOGLE_PROJECT_ID }}/pitpass-app/backend:latest
          docker push us-east1-docker.pkg.dev/${{ env.GOOGLE_PROJECT_ID }}/pitpass-app/backend:latest

      - name: Build and Push Frontend
        run: |
          # Frontend likely doesn't need root files, but for consistency 
          # we build from root as well.
          docker build -f ./packages/frontend/Dockerfile . -t us-east1-docker.pkg.dev/${{ env.GOOGLE_PROJECT_ID }}/pitpass-app/frontend:latest
          docker push us-east1-docker.pkg.dev/${{ env.GOOGLE_PROJECT_ID }}/pitpass-app/frontend:latest


      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Format Check
        working-directory: ./terraform
        run: terraform fmt -check

      - name: Terraform Plan
        working-directory: ./terraform
        run: terraform plan -input=false

      # Only run 'Apply' on pushes to the main branch
      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        working-directory: ./terraform
        run: terraform apply -auto-approve -input=false
